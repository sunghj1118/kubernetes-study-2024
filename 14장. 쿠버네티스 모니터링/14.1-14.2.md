## 14.0 들어가며

운영 단계의 클러스터를 운영하려면 모니터링 시스템은 필수

- 사용자 요청 급증에 따른 부하 감지
- 인프라 장애, 애플리케이션 장애 감지
- 애플리케이션의 리소스 사용 패턴 파악

…이지만 K8s 자체적으로 이런 메트릭들을 수집하는 기능들을 제공하지 않음. 그래서 보통 프로메테우스, 그라파나같은 오픈 소스와 조합해서 구축하는 것이 일반적임

- **프로메테우스**: 시계열 데이터를 통해 메트릭 수집, 다른 툴과의 호환성이 뛰어남
- **그라파나**: 메트릭 시각화 툴. 그래서 프로메테우스 + 그라파나 조합을 많이 씀

## 14.1 모니터링 기본 구조

모니터링 메트릭 수집의 전체적인 흐름

- **Exporter**: 데이터(메트릭)를 제공하는 서버 역할
    - CAdvisor의 `/metrics`처럼 메트릭을 제공하는 엔드포인트를 노출
        - 파이썬, 고랭의 내부 라이브러리로 직접 구현할 수도 있음
    - 프로메테우스에서 해당 엔드포인트에 접근해서 메트릭 수집
- **시계열 데이터베이스**: Exporter의 엔드포인트에 접근해서 자동으로 데이터 수집
    - e.g. 프로메테우스
    - 키-값 형태의 시계열 데이터 수집
        - 일반적으로 생각하는 키-값 데이터와 형식은 살짝 다름.
        - 공백으로 구분되는 `<메트릭 이름> <메트릭 값>` 형태
        
        ```
        process_open_fds 12
        go_gc_duration_seconds_sum 0.006515866
        go_gc_duration_seconds_count 134
        ...
        ```

## 14.2 모니터링 메트릭의 분류

모니터링 메트릭은 크게 3단계로 분류할 수 있음

- **인프라 수준 메트릭**
    - 호스트 레벨 메트릭을 의미함
    - 파일 디스크립터 개수, 디스크 사용량, NIC 패킷 전송량 등
- **컨테이너 수준 메트릭**:
    - 컨테이너의 CPU/메모리 사용량, 할당량
    - 컨테이너 프로세스 상태 및 파드 상태
- **애플리케이션 수준 메트릭**
    - 애플리케이션 로직에 관련된 데이터
    - 애플리케이션의 프레임워크가 제공하는 데이터
    - 마이크로서비스의 트레이싱 데이터 등