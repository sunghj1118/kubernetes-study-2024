# ì¿ ë²„ë„¤í‹°ìŠ¤ ìŠ¤ì¼€ì¤„ë§

**ìŠ¤ì¼€ì¤„ë§ì´ë€**

- ì»¨í…Œì´ë„ˆë‚˜ ê°€ìƒ ë¨¸ì‹ ê³¼ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒˆë¡œ ìƒì„±í•  ë•Œ, ê·¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì–´ëŠ ì„œë²„ì— ìƒì„±í•  ê²ƒì¸ì§€ë¥¼ ê²°ì •í•˜ëŠ” ì¼
- í´ë¼ìš°ë“œ ìì›ì˜ íš¨ìœ¨ì ì¸ ì‚¬ìš©ê³¼ ê³ ê°€ìš©ì„± í™•ë³´

![image](https://github.com/user-attachments/assets/acf8c7a6-6fe3-41cd-80c4-4b0c4ba021d4)

**ì™œ ì¤‘ìš”í• ê¹Œ?**

1. **íŠ¹ì •í•œ ìì› ìµœì í™”**
    
    ì˜ˆë¥¼ë“¤ì–´, ë¹ ë¥¸ íŒŒì¼ ì…ì¶œë ¥ì„ ìœ„í•´ SSDê°€ í•„ìš”í•œ ê²½ìš° SSDë¥¼ ê°€ì§„ ì›Œì»¤ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜!
    
2. **ë¶€í•˜ë¶„ì‚°**
    
    ì›Œí¬ ë…¸ë“œ ì „ì²´ì— ìµœëŒ€í•œ ê³¨ê³ ë£¨ íŒŒë“œë¥¼ ë°°ì¹˜í•´ì„œ ì„œë²„ê°€ ê³¼ë¶€í•˜ë˜ëŠ” ê±¸ ë§‰ì„ ìˆ˜ ìˆìŒ!
    
3. **ê³ ê°€ìš©ì„± ë³´ì¥**
    
    ì„œë²„ ì¥ì• ê°€ ë°œìƒí•´ë„ ì•±ì´ ë¬´ì¤‘ë‹¨ ìš´ì˜ ê°€ëŠ¥~
    

ìŠ¤ì¼€ì¤„ë§ ê³¼ì •ì„ ê°„ëµí•˜ê²Œ ì‚´í´ë³´ê³ , íŒŒë“œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ YAML íŒŒì¼ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ìŠ¤ì¼€ì¤„ë§ ì„¤ì •ê°’ì— ëŒ€í•´ ì•Œì•„ë³´ì





### 1. íŒŒë“œê°€ ì‹¤ì œë¡œ ë…¸ë“œì—ì„œ ìƒì„±ë˜ê¸°ê¹Œì§€ì˜ ê³¼ì •
- kubectlì´ë‚˜ API ì„œë²„ë¡œ íŒŒë“œ ìƒì„± ìš”ì²­ì„ ì „ì†¡í•˜ë©´ ì¼ì–´ë‚˜ëŠ” ì¼

```
ğŸ’¡
1. ServiceAccount, RoleBinding ë“±ì˜ ê¸°ëŠ¥ì„ ì´ìš©í•´ íŒŒë“œ ìƒì„± ìš”ì²­í•œ ì‚¬ìš©ìì˜ ì¸ì¦ ë° ì¸ê°€ ì‘ì—…ì„ ìˆ˜í–‰
2. ResourceQuota, LimitRangeì™€ ê°™ì€ ì–´ë“œë¯¸ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í•´ë‹¹ íŒŒë“œ ìš”ì²­ì„ ì ì ˆíˆ ë³€í˜•(Mutate)í•˜ê±°ë‚˜ ê²€ì¦(Validate)í•¨
3. ì–´ë“œë¯¸ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ê²€ì¦ì„ í†µê³¼í•´ ìµœì¢…ì ìœ¼ë¡œ íŒŒë“œ ìƒì„±ì´ ìŠ¹ì¸ ëë‹¤ë©´, k8sëŠ” í•´ë‹¹ íŒŒë“œë¥¼ ì›Œì»¤ ë…¸ë“œ ì¤‘ í•œê³³ì— ìƒì„±
```

ìŠ¤ì¼€ì¤„ë§ì€ 3ë‹¨ê³„ì—ì„œ ë°œìƒ! 

**ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì»´í¬ë„ŒíŠ¸ë“¤**
- ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì—¬ëŸ¬ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ê°€ ì‹¤í–‰ë˜ë©° `kube-system`Â ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ê´€ë¦¬ëœë‹¤.
- ê·¸ ì¤‘ì—ì„œë„ ìŠ¤ì¼€ì¤„ë§ì— ê´€ì—¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ëŠ” ë‹¤ìŒ 2ê°€ì§€
    - **`kube-scheduler`**: íŒŒë“œì˜ ìŠ¤ì¼€ì¤„ë§ ë‹´ë‹¹.
    - **`etcd`**: ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ìƒíƒœ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë¶„ì‚° í‚¤-ê°’ ë°ì´í„°ë² ì´ìŠ¤.
    - +) `kube-apiserver` : kubectlë¡œ ìƒí˜¸ í†µì‹ í•  ìˆ˜ ìˆëŠ” API ì„œë²„ ì»´í¬ë„ŒíŠ¸
- ì–˜ë„¤ ë˜í•œ íŒŒë“œë¡œì„œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— `kubectl get pods` ë¡œ ì‰½ê²Œ í™•ì¸ ê°€ëŠ¥

```bash
$ kubectl get pods -n kube-system
NAME                                  READY   STATUS    RESTARTS   AGE
etcd-ip-10-43-0-20.ap-northeast-2.compute.internal   1/1     Running   27         21d
kube-apiserver-ip-10-43-0-20.ap-northeast-2.compute.internal   1/1     Running   3          17h # í´ë¡œìŠ¤í„°ì™€ì˜ í†µì‹ ì„ìœ„í•œ ì„œë²„
kube-scheduler-ip-10-43-0-20.ap-northeast-2.compute.internal   1/1     Running   27         21d
```


**etcd**
- ë¶„ì‚° ì½”ë””ë„¤ì´í„°(Distributed Coordinator)ë¼ê³  ë¶ˆë¦¬ëŠ” ë„êµ¬ì˜ ì¼ì¢…
- ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„°ë¥¼ ì¡°ì •í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹
- ì¿ ë²„ë„¤í‹°ìŠ¤ ë˜í•œ í´ëŸ¬ìŠ¤í„° ìš´ìš©ì— í•„ìš”í•œ ì •ë³´ (í˜„ì¬ ìƒì„±ëœ ë””í”Œë¡œì´ë¨¼íŠ¸, íŒŒë“œ ëª©ë¡ ì •ë³´, í´ëŸ¬ìŠ¤í„° ìì²´ ì •ë³´)ë¥¼ etcdì— ì €ì¥

**etcd ì ‘ê·¼ë°©ì‹**
- ë¬´ì¡°ê±´ API ì„œë²„ë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥!
  ![image](https://github.com/user-attachments/assets/782252dc-bc9e-4a0e-91a1-2422b4d986f4)
    - ex) `kubectl get pods` ì‹¤í–‰ â†’ API ì„œë²„ì— ìš”ì²­ ì „ë‹¬ â†’  etcd ë°ì´í„° ì½ì–´ì™€ì„œ â†’ ë°˜í™˜

NodeNameí•­ëª© (etcdì— ì €ì¥ëœ)
- íŒŒë“œê°€ ì–´ëŠ ì›Œì»¤ ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥ !
```bash
$ kubectl get pods mypod -o yaml | grep -F3 nodeName
nodeName: ip-10-43-0-30.ap-northeast-2.compute.internal
```

**ìŠ¤ì¼€ì¤„ë§ ê³¼ì •**
1. **API ì„œë²„**: íŒŒë“œ ìƒì„± ìš”ì²­ -> etcdì— ì €ì¥. 
    ì´ë•Œ! nodenameì€ ë¹„ì–´ìˆìŒ.
2. **kube-scheduler**:Â **`nodeName`**ì´ ë¹„ì–´ ìˆëŠ” íŒŒë“œ ê°ì§€ -> ì í•©í•œ ë…¸ë“œ ì„ íƒ ->Â **`nodeName`**Â ì„¤ì •.
3. **kubelet**: Watchë¥¼ í†µí•´, API ì„œë²„ë¡œë¶€í„° **`nodeName`**ì´ ì„¤ì •ëœ íŒŒë“œ ì •ë³´ë¥¼ ê°ì§€í•˜ê³  í•´ë‹¹ ë…¸ë“œì—ì„œ íŒŒë“œ ì‹¤í–‰.


```ğŸ’¡
ğŸ’¡ğŸ’¡ë³µê¸°) Â `kubelet`ì€Â ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ ê° ì›Œì»¤ ë…¸ë“œì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ë°ëª¬
```






### 2. íŒŒë“œê°€ ìƒì„±ë  ë…¸ë“œë¥¼ ì„ íƒí•˜ëŠ” ìŠ¤ì¼€ì¤„ë§ ê³¼ì •

íŒŒë“œë¥¼ ì–´ë–¤ ë…¸ë“œì—ì„œ ì‹¤í–‰í•  ì§€ ë¬´ìŠ¨ ê¸°ì¤€ìœ¼ë¡œ ì •í• ê¹Œ?

**ìŠ¤ì¼€ì¤„ë§ì˜ í•µì‹¬ ë‹¨ê³„**
ìŠ¤ì¼€ì¤„ë§ ê³¼ì •ì—ì„œ íŒŒë“œë¥¼ ì‹¤í–‰í•  ì í•©í•œ ë…¸ë“œë¥¼ ì„ íƒí•˜ëŠ” ë‹¨ê³„ëŠ” í¬ê²Œ ë‘ ê°€ì§€ë¡œ ë‚˜ë‰œë‹¤.
1. ë…¸ë“œ í•„í„°ë§
2. ë…¸ë“œ ìŠ¤ì½”ì–´ë§


**1. ë…¸ë“œ í•„í„°ë§ (Filtering)**
íŒŒë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ëŠ” ë…¸ë“œë¥¼ ê±¸ëŸ¬ë‚´ëŠ” ë‹¨ê³„
- ì„¤ì •ëœ CPU, ë©”ëª¨ë¦¬ Requests ê°’ë³´ë‹¤ ìì›ì´ ë¶€ì¡±í•œ ë…¸ë“œ.
- ë…¸ë“œê°€ ì¥ì•  ìƒíƒœ (`kubectl get nodes`ì˜ STATUSê°€Â `Ready`ê°€ ì•„ë‹Œ ê²½ìš°).
- ë§ˆìŠ¤í„° ë…¸ë“œ(ê¸°ë³¸ì ìœ¼ë¡œ ì›Œí¬ë¡œë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ).

**2. ë…¸ë“œ ìŠ¤ì½”ì–´ë§ (Scoring)**
í•„í„°ë§ ë‹¨ê³„ì—ì„œ ë‚¨ì€ í›„ë³´ ë…¸ë“œì— ì ìˆ˜ë¥¼ ë§¤ê²¨ ìµœì ì˜ ë…¸ë“œë¥¼ ì„ íƒ
- íŒŒë“œì˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ê°€ ì´ë¯¸ ë¡œì»¬ì— ì¡´ì¬í•˜ë©´ ì ìˆ˜ ì¦ê°€.
- ë…¸ë“œì˜ ìì› ì—¬ìœ ê°€ ë§ì„ìˆ˜ë¡ ì ìˆ˜ ì¦ê°€.
ìµœê³ ë“ì  ë…¸ë“œê°€ íŒŒë“œë¥¼ ì‹¤í–‰í•˜ê²Œ ëœë‹¹!!!

ë…¸ë“œ ìŠ¤ì½”ì–´ë§ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì— ë‚´ì¥ëœ ë¡œì§ì— ì˜í•´ ê³„ì‚°ë˜ê¸° ë•Œë¬¸ì— ì•Œê³ ë¦¬ì¦˜ ìˆ˜ì • ê²½ìš°ê°€ ë§ì§€ ì•ŠìŒ!
ë”°ë¼ì„œ ìŠ¤ì¼€ì¤„ë§ ì¡°ê±´ì„ YAML íŒŒì¼ì— ì„¤ì •í•´ì„œ ë…¸ë“œ í•„í„°ë§ ë‹¨ê³„ì—ì„œ ì ìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤.
ë…¸ë“œ í•„í„°ë§ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ë“¤ì„ ì‚´í´ë³´ì.


### 3. NodeSelectorì™€ Node Affinity, Pod Affinity
âœ…ì´ë²ˆ ì¥ì˜ ì˜ˆì œë“¤ì€ ë³„ë„ ì–¸ê¸‰ì´ ì—†ëŠ” í•œ  **1ê°œì˜ ë§ˆìŠ¤í„°ì™€ 3ê°œì˜ ì›Œì»¤ë…¸ë“œ**ë¡œ êµ¬ì„±ëœ í´ëŸ¬ìŠ¤í„° ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…

```bash
$ kubectl get nodes
NAME               STATUS   ROLES                  AGE   VERSION
ip-172-16-0-10     Ready    control-plane,master   21m   v1.23.6
ip-172-16-0-30     Ready    <none>                 91m   v1.23.6
ip-172-16-0-32     Ready    <none>                 91m   v1.23.6
```


**1. nodeNameê³¼ nodeSelectorë¥¼ ì‚¬ìš©í•œ ìŠ¤ì¼€ì¤„ë§ ë°©ë²•**
- nodeName : íŠ¹ì • ì›Œì»¤ ë…¸ë“œì— íŒŒë“œ ë°°ì¹˜í•˜ëŠ” ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•!
- YAML íŒŒì¼ì„ ì‘ì„±í•˜ì—¬Â **`nodeName`**ì„ ëª…ì‹œ
**`nodename-nginx.yaml`**:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  nodeName: ip-10-43-0-30.ap-northeast-2.compute.internal
  containers:
  - name: nginx
    image: nginx:latest
```
```bash
$ kubectl apply -f nodename-nginx.yaml
$ kubectl get pods -o wide
NAME    READY   STATUS    RESTARTS   AGE   IP           NODE
nginx   1/1     Running   0          61s   192.168.1.55   ip-10-43-0-30...
```

- **ì£¼ì˜ì‚¬í•­**: ê³ ì •ëœ ë…¸ë“œ ì´ë¦„ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë…¸ë“œê°€ ë‹¤ìš´ë˜ê±°ë‚˜ í™˜ê²½ ë³€í•˜ë©´ YAMLíŒŒì¼ ìˆ˜ì •í•´ì•¼ë¨. ìœ ì—°ì„± ë–¨ì–´ì§
- **ë³´ì™„**: ë¼ë²¨(Label) ê¸°ë°˜ ë°°ì¹˜ê°€ ê¶Œì¥ë¨!
    - ë…¸ë“œì— ë¼ë²¨ ì„¤ì •í•´ì„œ íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” ë…¸ë“œë¡œ íŒŒë“œë¥¼ ë°°ì¹˜í•˜ëŠ” ë°©ë²•
    - ë” ìœ ì—°í•œ ë°©ë²•ì„

**ë¼ë²¨ì„ ì‚¬ìš©í•œ ë…¸ë“œ ì„ íƒì˜ ì˜ˆì‹œ**
ì¼ë‹¨ì€ ë¼ë²¨ì„ ì¶”ê°€í•´ë³´ì.
![image](https://github.com/user-attachments/assets/0f200d08-fcc4-4708-be40-ebb96437cbb5)
```bash
# ë…¸ë“œ ë¼ë²¨ í™•ì¸í•˜ê¸°
$ kubectl get nodes --show-labels
NAME                                STATUS   AGE   VERSION   LABELS
ip-172-43-0-20.ap-northeast-2...    Ready    6h3m  v1.23.6   beta.kubernetes.io/arch=amd64,
                                                              beta.kubernetes.io/instance-type=t2.medium,
                                                              beta.kubernetes.io/os=linux, ...

# ë…¸ë“œì— ë¼ë²¨ ì¶”ê°€í•˜ê¸° (mylabel/disk=ssd)
$ kubectl label nodes ip-10-43-0-30.ap-northeast-2.compute.internal mylabel/disk=ssd
node/ip-10-43-0-30.ap-northeast-2.compute.internal labeled

# ë…¸ë“œì— ë¼ë²¨ ì¶”ê°€í•˜ê¸°(mylabel/disk=hdd)
$ kubectl label nodes ip-10-43-0-31.ap-northeast-2.compute.internal mylabel/disk=hdd
$ kubectl label nodes ip-10-43-0-32.ap-northeast-2.compute.internal mylabel/disk=hdd
node/ip-10-43-0-31.ap-northeast-2.compute.internal labeled
node/ip-10-43-0-32.ap-northeast-2.compute.internal labeled

# ë…¸ë“œì— ì¶”ê°€ëœ ë¼ë²¨ í™•ì¸
kubectl get nodes --show-labels
NAME                           STATUS   ROLES    AGE   VERSION   LABELS
ip-10-43-0-30.ap-northeast-2   Ready    <none>   63m   v1.23.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.medium,beta.kubernetes.io/os=linux,kubernetes.io/hostname=ip-10-43-0-30,mylabel/disk=ssd
ip-10-43-0-31.ap-northeast-2   Ready    <none>   63m   v1.23.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.medium,beta.kubernetes.io/os=linux,kubernetes.io/hostname=ip-10-43-0-31,mylabel/disk=hdd
ip-10-43-0-32.ap-northeast-2   Ready    <none>   63m   v1.23.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.medium,beta.kubernetes.io/os=linux,kubernetes.io/hostname=ip-10-43-0-32,mylabel/disk=hdd

# ë…¸ë“œ ë¼ë²¨ ì œê±°
$ kubectl label nodes ip-10-43-0-32.ap-northeast-2.compute.internal mylabel/disk-
```

**nodeSelector** 
- íŠ¹ì • ë¼ë²¨ì´ ì„¤ì •ëœ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜!
- nodeSelectorëŠ” í•´ë‹¹ ë¼ë²¨ì´ ì¡´ì¬í•˜ëŠ” ë…¸ë“œê°€ ì—¬ëŸ¬ ê°œì¼ ê²½ìš° ê·¸ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ê¸° ë•Œë¬¸ì— ë…¸ë“œì˜ ì´ë¦„ì— ì¢…ì†ì ì´ì§€ ì•Šê²Œ YAMLíŒŒì¼ì„ ì‘ì„±í•  ìˆ˜ ìˆìŒ.
- Pod ë°°í¬ YAML íŒŒì¼ **`nodeselector-nginx.yaml`**
    - ë‹¨ì¼ íŒŒë“œë¥¼ ë°°í¬í•  ë•Œ ì‚¬ìš©

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-nodeselector
spec:
  nodeSelector: # ì´ë¶€ë¶„! 
    mylabel/disk: hdd
  containers:
  - name: nginx
    image: nginx:latest
```
- Deployment ë°°í¬ YAML íŒŒì¼ **`deployment-nginx-nodeselector.yaml`**
    - ì•„ë˜ ì˜ˆì‹œë¡œ 3ê°œì˜ íŒŒë“œê°€ ìƒì„±ë˜ê³  mylabel/disk=hdd ë¼ë²¨ì´ ìˆëŠ” ë…¸ë“œì—ë§Œ ë°°ì¹˜ë¨
    - ë¼ë²¨ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë…¸ë“œê°€ ì—¬ëŸ¬ê°œë¼ë©´ ê° íŒŒë“œëŠ” ë‹¤ë¥¸ ë…¸ë“œì— ë¶„ì‚°ë  ìˆ˜ ìˆìŒ ! ì¦‰, ë¬´ì¡°ê±´ íŒŒë“œë“¤ì´ ë‹¤ ë™ì¼í•œ ë…¸ë“œì— ë°°ì¹˜ë˜ëŠ” ê±° ì•„ë‹˜

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: deployment-nginx
  template:
    metadata:
      labels:
        app: deployment-nginx
    spec:
      nodeSelector: # ì´ë¶€ë¶„! 
        mylabel/disk: hdd
      containers:
      - name: nginx
        image: nginx:latest

```


**2. Node Affinityë¥¼ ì´ìš©í•œ ìŠ¤ì¼€ì¤„ë§ ë°©ë²•** 

nodeSelector: ë‹¨ìˆœíˆ ë¼ë²¨ì˜ í‚¤-ê°’ì´ ê°™ì€ì§€ë§Œ ë¹„êµí•´ ë…¸ë“œ ì„ íƒí•˜ë¯€ë¡œ í™œìš© ë°©ë²•ì´ ë‹¤ì–‘í•˜ì§„ ì•ŠìŒ. 

**NodeSelector**ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•˜ì—¬, ë…¸ë“œ ì„ íƒ ì¡°ê±´ì„Â **Hard**(í•„ìˆ˜ ì¡°ê±´) ë˜ëŠ”Â **Soft**(ì„ í˜¸ ì¡°ê±´)ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŒ
1. **requiredDuringSchedulingIgnoredDuringExecution**: ë°˜ë“œì‹œ ì¶©ì¡±í•´ì•¼ í•˜ëŠ” ì¡°ê±´
2. **preferredDuringSchedulingIgnoredDuringExecution**: ì„ í˜¸í•˜ëŠ” ì¡°ê±´(ì¶©ì¡±ë˜ì§€ ì•Šì•„ë„ ë°°ì¹˜ ê°€ëŠ¥)

ì˜ˆì‹œë¥¼ ì‚´í´ë³´ì
- **Hard ì¡°ê±´ì„ ì‚¬ìš©í•œ YAML ì˜ˆì‹œ** **`nodeaffinity-required.yaml`**
    - ì¡°ê±´ì„ ì¶©ì¡±í•˜ì§€ ì•ŠëŠ” ë…¸ë“œì—ëŠ” ì ˆëŒ€ íŒŒë“œê°€ ë°°ì¹˜ë˜ì§€ ì•ŠìŒ.
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-nodeaffinity-required
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: mylabel/disk ## ë¼ë²¨ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ê±´ì„ ì„¤ì •.
            operator: In ## ssd ë˜ëŠ” hdd ê°’ ì¤‘ í•˜ë‚˜ë¥¼ ê°€ì§„ ë…¸ë“œì— íŒŒë“œ ë°°ì¹˜.
            values:
            - ssd
            - hdd
  containers:
  - name: nginx
    image: nginx:latest
```

- **Soft ì¡°ê±´ì„ ì‚¬ìš©í•œ YAML ì˜ˆì‹œ `nodeaffinity-preferred.yaml`**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-nodeaffinity-preferred
spec:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 80 #ì¡°ê±´ì˜ ì¤‘ìš”ë„ë¥¼ ì„¤ì • (ìˆ«ìê°€ í´ìˆ˜ë¡ ìš°ì„  ì ìš©)
        preference: # ssd ë¼ë²¨ì´ ìˆëŠ” ë…¸ë“œë¥¼ ì„ í˜¸í•˜ì§€ë§Œ, ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•Šì•„ë„ ë‹¤ë¥¸ ë…¸ë“œì— ë°°ì¹˜ ê°€ëŠ¥
          matchExpressions:
          - key: mylabel/disk
            operator: In 
            values:
            - ssd
  containers:
  - name: nginx
    image: nginx:latest
```

```bash
# ìœ„ YAML íŒŒì¼ ì ìš©ì‹œì¼œì£¼ê¸°
$ kubectl apply -f nodeaffinity-required.yaml
$ kubectl apply -f nodeaffinity-preferred.yaml
pod/nginx-nodeaffinity-required created
pod/nginx-nodeaffinity-preferred created

# ë°°í¬ëœ íŒŒë“œ ìƒíƒœ í™•ì¸
$ kubectl get pods -o wide
NAME                              READY   STATUS    RESTARTS   AGE   IP           NODE
nginx-nodeaffinity-required       1/1     Running   0          30s   192.168.1.5  ip-10-43-0-30
nginx-nodeaffinity-preferred      1/1     Running   0          25s   192.168.1.6  ip-10-43-0-31
```




**3. Pod Affinityë¥¼ ì´ìš©í•œ ìŠ¤ì¼€ì¤„ë§ ë°©ë²•** 

Pod AffinityëŠ” íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”Â ë‹¤ë¥¸ íŒŒë“œê°€ ì‹¤í–‰ ì¤‘ì¸ ë…¸ë“œì— íŒŒë“œë¥¼ ë°°ì¹˜í•˜ëŠ” ë°©ë²•! Node Affinityì™€ëŠ” ë‹¤ë¥´ê²Œ, íŒŒë“œ ê°„ì˜ ìƒí˜¸ ê´€ê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ì„ ìˆ˜í–‰
- ì‚¬ìš©ë°©ë²•ì€ node affinityì™€ ê±°ì˜ ê°™ìŒ!

  **`podaffinity-required.yaml`**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-podaffinity
spec:
  affinity:
    podAffinity: #íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” íŒŒë“œê°€ ìˆëŠ” ë…¸ë“œì— ìƒˆ íŒŒë“œë¥¼ ë°°ì¹˜
      requiredDuringSchedulingIgnoredDuringExecution: # ì„¤ì •ëœ ì¡°ê±´ì„ ë°˜ë“œì‹œ ì¶©ì¡±í•´ì•¼ë§Œ ìŠ¤ì¼€ì¤„ë§
        labelSelector: #mylabel/database=mysql ë¼ë²¨ì´ ì„¤ì •ëœ íŒŒë“œì™€ ë™ì¼í•œ ë…¸ë“œë¡œ ìŠ¤ì¼€ì¤„ë§
          matchExpressions:
          - key: mylabel/database
            operator: In
            values:
            - mysql
        topologyKey: failure-domain.beta.kubernetes.io/zone
        #ìš” topologyKeyê°’ì´ ë™ì¼í•œ ë…¸ë“œë“¤ ì¤‘ì—ì„œ ìŠ¤ì¼€ì¤„ë§ì„ ìˆ˜í–‰
        #íŠ¹ì • Zone ë‚´ì—ì„œ íŒŒë“œë¥¼ ë°°ì¹˜í•˜ë„ë¡ ì„¤ì •
  containers:
  - name: nginx
    image: nginx:latest
```

ìš” YAML íŒŒì¼ì˜ ê²½ìš°ì—ëŠ” ì•„ë˜ ì‚¬ì§„ì—ì„œ ë…¸ë“œ Aí˜¹ì€ ë…¸ë“œ Bì— í• ë‹¹ë  ìˆ˜ ìˆë‹¤!

![image](https://github.com/user-attachments/assets/d82ef2ac-cff8-44c5-ace3-e9ddf430d194)
```bash
$ kubectl apply -f podaffinity-required.yaml
pod/nginx-podaffinity created

$ kubectl get pods -o wide
NAME                READY   STATUS    RESTARTS   AGE   IP           NODE
nginx-podaffinity   1/1     Running   0          30s   192.168.1.7  ip-10-43-0-32
```

- 2ê°œ íŒŒë“œë¥¼ ë™ì¼í•œ AZ or Regionì˜ ë…¸ë“œì— í• ë‹¹í•´ì•¼í•˜ëŠ” ê²½ìš° í™œìš©í•˜ê¸° ì¢‹ìŒ

í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ Pod Affinityë¥¼ ì„¤ì •í•œë‹¤ë©´????

**`podaffinity-hostname-topology.yaml`**

```yaml
 podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        labelSelector:
          matchExpressions:
          - key: mylabel/database
            operator: In
            values:
            - mysql
        topologyKey: kubernetes.io/hostname #ìš”ë¶€ë¶„!
        #kubernetes.io/hostnameì€ ê¸°ë³¸ì ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ëª¨ë“  ë…¸ë“œì— ì„¤ì •í•˜ëŠ” ë¼ë²¨ë¡œ, ë…¸ë“œì˜ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì„ ë‚˜íƒ€ëƒ„
```

- ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ë…¸ë“œì˜ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì€ ê³ ìœ í•˜ê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ í† í´ë¡œì§€ì— ë‘ ê°œ ì´ìƒì˜ ë…¸ë“œê°€ ì¡´ì¬í•  ìˆ˜ ì—†ì–´ì§!!!
- í•˜ë‚˜ì˜ ë…¸ë“œê°€ í•˜ë‚˜ì˜ í† í´ë¡œì§€ì— ëŒ€ì‘ëœë‹¤ëŠ” ì˜ë¯¸
- matchExpressoinì„ ë°˜ë“œì‹œ ë§Œì¡±í•˜ëŠ” íŒŒë“œê°€ ìœ„ì¹˜í•œ ë…¸ë“œë¥¼ ì„ íƒí•˜ê²Œë  ê²ƒ
![image](https://github.com/user-attachments/assets/ef7d881c-9e09-4adc-ad41-2239660207e1)




**4. Pod Anti-affinityë¥¼ ì´ìš©í•œ ìŠ¤ì¼€ì¤„ë§ ë°©ë²•**
![image](https://github.com/user-attachments/assets/247a59be-6438-4c16-b19d-7f939f680f06)
- Pod Affinityì™€ ë°˜ëŒ€ë¡œ ë™ì‘!
    - íŠ¹ì • íŒŒë“œê°€Â **ê°™ì€ í† í´ë¡œì§€(ì˜ˆ: Zone, Region)**Â ë‚´ì˜ ë…¸ë“œì— ë°°ì¹˜ë˜ì§€ ì•Šë„ë¡ ì„¤ì •í•˜ì—¬ **ê³ ê°€ìš©ì„±(HA)**ê³¼Â **ë¦¬ì†ŒìŠ¤ ë¶„ì‚°**ì„ ë³´ì¥í•˜ëŠ” ìŠ¤ì¼€ì¤„ë§ ë°©ì‹
- **`podAffinity`**ë¥¼Â **`podAntiAffinity`**ë¡œ ë³€ê²½í•˜ë©´ ì ìš©ë¨!
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-antiaffinity
spec:
  affinity:
    podAntiAffinity: ## ìš”ë¶€ë¶„
      requiredDuringSchedulingIgnoredDuringExecution: #ì¡°ê±´ì„ ë°˜ë“œì‹œ ì¶©ì¡±!!!
      ##ë¬´ì¡°ê±´ ì•„ë˜ì˜ ì• ë‘ì€ ë‹¤ë¥¸ í† í´ë¡œì§€ì— ë°°ì¹˜
        - labelSelector:
            matchExpressions:
              - key: mylabel/database
                operator: In
                values:
                  - mysql
          topologyKey: failure-domain.beta.kubernetes.io/zone
  containers:
    - name: nginx
      image: nginx:latest

```
```yaml
spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution: ## ê°€ê¸‰ì  ì¶©ì¡±
      #ê°€ê¸‰ì ë‹¤ë¥¸ í† í´ë¡œì§€ì— íŒŒë“œ ë°°ì¹˜í•˜ë ¤ê³  í•˜ì§€ë§Œ,, ë™ì¼í•œ í† í´ë¡œì§€ì— ë°°ì¹˜ë  ìˆ˜ë„ 
        - podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: mylabel/database
                  operator: In
                  values:
                    - mysql
            topologyKey: failure-domain.beta.kubernetes.io/zone
          weight: 80

```

**ê° ë…¸ë“œì— í•˜ë‚˜ì˜ íŒŒë“œë§Œ 1:1ë¡œ ë°°ì¹˜ë˜ë„ë¡ í•´ì„œ ë…ì ì  ë°°ì¹˜ ë³´ì¥í•˜ê¸°!** 
ì–¸ì œ? DaemonSetì²˜ëŸ¼ ë…¸ë“œë§ˆë‹¤ ê³ ìœ ì˜ íŒŒë“œë¥¼ ë°°ì¹˜í•  ë•Œ ìœ ìš©
- topologyë¥¼ hostnameìœ¼ë¡œ ìœ„ì— ì–¸ê¸‰í–ˆë“¯ì´ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¹(hostnameì€ ë¬´ì¡°ê±´ ê³ ìœ í•˜ë‹ˆê¹Œ..)
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx
  labels:
    app: deployment-nginx
spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - deployment-nginx
            topologyKey: kubernetes.io/hostname
          weight: 100
```
